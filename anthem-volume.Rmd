---
output:
  html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```
<style type="text/css">
div.main-container {
  max-width: 2000px;
  margin-left: 0;
  margin-right: auto;
}
</style>
<style>
.tocify {
color: black;
}
<!-- } -->
<!-- .tocify .tocify-header { -->
<!--     position: fixed; -->
<!--     <!-- top: 50px; --> -->
<!--     left: 50px; -->
<!--     width: 350px; -->
<!--     <!-- border: solid 3px black; --> -->
<!--     <!-- height: 200px; --> -->
<!--  border: none; -->
<!-- } -->
.tocify .tocify-header .active {
color: white;
background: #d80b8c;
font-weight: bold;
}
<!-- .tocify .tocify-item { -->
<!-- background: white; -->
<!-- color: black; -->
<!--  border: none; -->
<!-- } -->
</style>
<style>
  .nav-pills>li>a:hover, .nav-pills>li>a:focus, .nav-pills>li.active>a,     .nav-pills>li.active>a:hover, .nav-pills>li.active>a:focus{
     background-color: #212070;
     }
</style>
<style>
.container { width: 1800px; }
h2 {
  background-color: #dddedd;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h3 {
  background-color: #f2f2f2;
  color: black;
  text-indent: 20px;
  <!-- font-weight: bold; -->
}
h4 {
  <!-- background-color: #dddedd; -->
  <!-- color: black; -->
  text-indent: 50px;
  <!-- font-weight: bold; -->
}
</style>
<style>
.blackbox {
  padding: 1em;
  background: white;
  color: black;
  border: 2px solid #7f7f7f;
  width: 100%;
  position: center;
  align: center;
  margin: 0px auto;
}
.center {
  text-align: left;
  margin: 0px auto;
}
</style>
<!-- ```{css toc-content, echo = FALSE} -->
<!-- #TOC { -->
<!--   right: 270px; -->
<!--   margin: 20px 0px 25px 0px; -->
<!-- } -->
<!-- .main-container { -->
<!--     margin-left: 200px; -->
<!-- } -->
<!-- ``` -->
```{r Load Packages, echo = FALSE, warning = FALSE, message = FALSE}

# # Load packages -----------------------------------------------------------------------------------
suppressMessages({
  memory.limit(size = 8000000)
  library(readxl)
  library(writexl)
  library(plyr)
  library(dplyr)
  library(data.table)
  library(zoo)
  library(shiny)
  library(shinydashboard)
  library(shinydashboardPlus)
  library(shinyWidgets)
  library(htmlwidgets)
  library(lubridate)
  library(tcltk)
  library(tidyverse)
  library(plotly)
  library(knitr)
  library(kableExtra)
  library(leaflet)
  library(grid)
  library(gridExtra)
  library(eeptools)
  library(ggQC)
  library(zipcodeR)
  library(utils)
  library(scales)
  library(chron)
  library(bupaR)
  library(shiny)
  library(DT)
  library(DiagrammeR)
  library(shinyalert)
  library(edeaR)
  library(processmapR)
  library(processmonitR)
  library(processanimateR)
  library(tidyr)
  library(lubridate)
  library(RColorBrewer)
  library(DiagrammeR)
  library(ggplot2)
  library(leaflet)
  library(readr)
  library(highcharter)
  library(ggforce) # for 'geom_arc_bar'
  library(packcircles) # for packed circle graph
  library(viridis)
  library(ggiraph)
  library(treemapify)
  library(treemap)
  library(broom)
  library(extrafont)
  library(tis) # for US holidays
  library(vroom)
  library(sjmisc)
  library(tools)
  library(here)
  library(shinyBS)
  library(shinyscreenshot)
  library(fasttime)
  library(shinycssloaders)
  library(feather)
  # library(zipcodeR)
  library(formattable)
  library(shinyjs)
  library(janitor)
  library(patchwork)
  library(flexdashboard)
  # library(tidyverse)
  # library(viridis)
  # library(hrbrthemes)
  # library(plotly)
  # install.packages("bsts")
  library(bsts)
  library(reactable)
  # install.packages("reactablefmtr")
  library(reactablefmtr)
  library(svDialogs)
  # library(openxlsx)
  library(flextable)
  library(officedown)
  library(officer)
  library(magrittr)
  library(webshot) 
  library(png)
  library(ggh4x)
  library(RODBC)
  library(DBI)
  library(odbc)
  library(dbplyr)
  library(pool)
  library(emojifont)
  library(lubridate)
})

# devtools::install_github("hafen/lazyrmd")
# require(lazyrmd)
# 
# options(repos = c(tessera = "http://packages.tessera.io",
#   getOption("repos")))
# install.packages("lazyrmd")
# require(lazyrmd)

```


```{r Graph asthetics, echo = FALSE, warning = FALSE, message = FALSE}
### Color Functions for Graphs ============================================================

# Mount Sinai corporate colors "USE THIS TO ADD COLORS"
MountSinai_colors <- c(
  `dark purple`  = "#212070",
  `dark pink`    = "#d80b8c",
  `dark blue`    = "#00aeef",
  `dark grey`    = "#7f7f7f",
  `yellow`       = "#ffc000",
  `purple`       = "#7030a0",
  `med purple`   = "#5753d0",
  `med pink`     = "#f75dbe",
  `med blue`     = "#5cd3ff",
  `med grey`     = "#a5a7a5",
  `light purple` = "#c7c6ef",
  `light pink`   = "#fcc9e9",
  `light blue`   = "#c9f0ff",
  `light grey`   = "#dddedd"
  )

# Function to extract Mount Sinai colors as hex codes
# Use Character names of MountSinai_colors

MountSinai_cols <- function(...) {
  cols <- c(...)
  
  if (is.null(cols))
    return (MountSinai_colors)
  
  MountSinai_colors[cols]
}

# Color Function that can be used to call all colors is "MountSinai_cols()"
# Use in ggplot 

  #MountSinai_cols()       # will provide all colors and their hex codes in a table 
  #MountSinai_cols("pink") # will provide color name and the hex code for the pink color

# Create palettes 
MountSinai_palettes <- list(
  `all`   = MountSinai_cols("dark purple","dark pink","dark blue","dark grey",
                            "med purple","med pink","med blue","med grey", 
                            "light purple","light pink","light blue","light grey"),
  
  `main`  = MountSinai_cols("dark purple","dark pink","dark blue","dark grey"),
  
  `purple`  = MountSinai_cols("dark purple","med purple","light purple"),
  
  `pink`  = MountSinai_cols("dark pink","med pink","light pink"),
  
  `blue`  = MountSinai_cols("dark blue", "med blue", "light blue"),
  
  `grey`  = MountSinai_cols("dark grey", "med grey", "light grey"),
  
  `purpleGrey` = MountSinai_cols("dark purple", "dark grey"),
  
  `pinkBlue` = MountSinai_cols("dark pink", "dark blue")
  
)

# MountSinai_palettes
# Return function to interpolate a Mount Sinai color palette
# default value is the main palette, reverse = True will change the order

MountSinai_pal <- function(palette = "all", reverse = FALSE, ...) {
  pal <- MountSinai_palettes[[palette]]
  
  if (reverse) pal <- rev(pal)
  
  colorRampPalette(pal, ...)
}



# Scale Function for ggplot can be used instead of scale_color_manual
scale_color_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)
  
  if (discrete) {
    discrete_scale("colour", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}

# Scale Fill for ggplot insetead of scale_fill_manual 
scale_fill_MountSinai <- function(palette = "all", discrete = TRUE, reverse = FALSE, ...) {
  pal <- MountSinai_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("MountSinai_", palette), palette = pal, ...)
  } else {
    scale_fill_gradientn(colours = pal(256), ...)
  }
}

# Use in ggplot 
  # scale_color_MountSinai("main")

```


```{r Global Functions, echo = FALSE, warning = FALSE, message = FALSE}

'%!in%' <- function(x,y)!('%in%'(x,y)) # Does not include
not_all_na <- function(x) all(!is.na(x)) # Exclude columns with All NAs

```


```{r Data Connections, echo = FALSE, warning = FALSE, message = FALSE}

# Connection to Oracle DB ------------------------------------------------------
conn1 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB SoYoun", timeout = 30)
conn3 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB Production", timeout = 30)
conn2 <- dbConnect(odbc(), 
                  "Clarity_prod", 
                  uid = "kweons01" , 
                  pwd = "kweons01123$")
conn4 <- dbPool(drv = odbc(), dsn = "OAO Cloud DB Staging", timeout = 30)

conn5 <- dbConnect(odbc(),
                    Driver = "SQLServer",
                    # Server = "10.2.42.69", # old server
                    Server = "datahub-synapse.sql.azuresynapse.net",
                    database = "datahub_epic_dw",
                    UID = "MSS_USER",
                    PWD = "Apple_Bees456$",
                    Port = 1433)



# Clarity Connection  ------------------------------------------------
slot_raw_tbl <- tbl(conn2, "Y_DM_BOOKED_FILLED_RATE")
access_raw_tbl <- tbl(conn2, "MV_DM_PATIENT_ACCESS")
f_sched_appt_tbl <- tbl(conn2, "F_SCHED_APPT")
availability_raw_tbl <- tbl(conn2, "V_AVAILABILITY")
block_raw_tbl <- tbl(conn2, "AVAIL_BLOCK")
block_name_tbl <- tbl(conn2, "ZC_APPT_BLOCK")
orders_raw_tbl <- tbl(conn2, "ORDER_PROC")
visit_type_tbl <- tbl(conn2, "CL_PRC_VT_GROUPS")
visit_type_mapping_tbl <- tbl(conn2, "ZC_VISIT_TYPE_GRP")

dep_mapping_tbl <- tbl(conn2, "CLARITY_DEP")
dep_mapping <- dep_mapping_tbl %>%
  # dplyr::select(DEPARTMENT_ID, SPECIALTY) %>%
  collect()

clarity_ser_tbl <- tbl(conn2, "CLARITY_SER")
clarity_ser_2_tbl <- tbl(conn2, "CLARITY_SER_2")

finclass_tbl <- tbl(conn2, "V_PB_EPP_CUSTOM_PRD_TYPE")


# Local Connection ---------------------------------------------------
radiology_dep_mapping_tbl <- tbl(conn1, "RADIOLOGY_DEP_MAPPING")

clarity_ser_tbl_loc <- tbl(conn1, "CLARITY_SER")
clarity_ser_2_tbl_loc <- tbl(conn1, "CLARITY_SER_2")

dep_mapping_tbl_loc <- tbl(conn1, "CLARITY_DEP")

slot_data_raw_tbl <- tbl(conn1, "ALL_SLOTS")
slot_data_tbl <- tbl(conn1, "SLOT_DATA")
slot_data_prc_raw_tbl <- tbl(conn1, "ALL_SLOTS_PRC")
slot_data_prc_tbl <- tbl(conn1, "SLOT_DATA_PRC")

block_raw_tbl_loc <- tbl(conn1, "AVAIL_BLOCK")
block_name_tbl_loc <- tbl(conn1, "ZC_APPT_BLOCK")




#slot_view_tbl <- tbl(conn3, in_schema("OAO_PRODUCTION", "AMBULATORY_SLOT_TABLE"))


# Azure Connection ---------------------------------------------------
# access_raw_tbl <- tbl(conn5, in_schema("CLARITY", "MV_DM_PATIENT_ACCESS"))
# f_sched_appt_tbl <- tbl(conn5, dbplyr::ident_q('"CLARITY"."F_SCHED_APPT"'))
clarity_dep_conn <- tbl(conn5, dbplyr::ident_q('"Clarity"."CLARITY_DEP"'))

referrals_conn <- tbl(conn5, dbplyr::ident_q('"MS_SOLUTIONS_DEV"."y_s2_referrals_tmp"'))
caboodle_referrals_conn <- tbl(conn5, dbplyr::ident_q('"CABOODLE"."ReferralsDataView"'))
caboodle_referralFact_conn <- tbl(conn5, dbplyr::ident_q('"CABOODLE"."ReferralFact"'))
patient_conn <- tbl(conn5, dbplyr::ident_q('"CABOODLE"."PatientDim"'))
department_conn <- tbl(conn5, dbplyr::ident_q('"CABOODLE"."DepartmentDim"'))

clarity_referrals_tbl <- tbl(conn5, dbplyr::ident_q('"Clarity"."REFERRAL"'))
clarity_referrals_wq_tbl <- tbl(conn5, dbplyr::ident_q('"Clarity"."REFERRAL_WQ"'))

visitFact_conn <- tbl(conn5, dbplyr::ident_q('"Caboodle"."VisitFact"'))


```



```{r Report Variables, echo = FALSE, warning = FALSE, message = FALSE}

report_run_date <- Sys.Date()
date_start <- format(Sys.Date(), "%Y-%m-%d")
date_next_14days <- format(Sys.Date() +13, "%Y-%m-%d")
slot_date_start <- format(Sys.Date() -2, "%Y-%m-%d")
# date_start <- paste0(format(Sys.Date(), "%Y-%m"),"-01")

current_year <- format(report_run_date, "%Y")
prior_year <- as.character(as.numeric(current_year) -1)
baseline_year <- as.character(as.numeric(current_year) -2)

current_month <- format(report_run_date, "%m")

current_year_month <- paste0(current_year,"-",current_month)
```



```{r}

# access <- access_raw_tbl %>%
#   filter(DERIVED_STATUS_DESC== "Arrived") %>%
#   filter(year(CONTACT_DATE) == "2026") %>%
#   group_by(CONTACT_DATE) %>%
#   summarise(total = n()) %>%
#   collect()

finclass_tbl <- tbl(conn2, "V_PB_EPP_CUSTOM_PRD_TYPE")

anthem_plans <- read_excel("Anthem Visit Plans.xlsx")
anthem_plans2 <- anthem_plans %>%
  dplyr::select(BENEFIT_PLAN_NAME, PlanLabel) %>%
  distinct()
anthem_plan_list <- as.vector(unique(anthem_plans2$BENEFIT_PLAN_NAME))
anthem_mcr_adv_list <- as.vector(unique(anthem_plans2$BENEFIT_PLAN_NAME[anthem_plans2$PlanLabel == "Medicare Advantage"]))

mss_exclusion <- read_excel("MSS Exclusions.xlsx")
mss_exclusion_list <- as.vector(unique(mss_exclusion$GROUP_NUM))
mss_exclusion_paul_weiss <- as.vector(unique(mss_exclusion$GROUP_NUM[
    str_detect(mss_exclusion$GROUP_NAME, "PAUL WEISS")
  ]))
mss_exclusion_32bj <- as.vector(unique(mss_exclusion$GROUP_NUM[
    str_detect(mss_exclusion$GROUP_NAME, "32BJ")
  ]))
mss_exclusion_millbank <- as.vector(unique(mss_exclusion$GROUP_NUM[
    str_detect(mss_exclusion$GROUP_NAME, "MILBANK")
  ]))


coc_flag <- tbl(conn2, "PATIENT_FYI_FLAGS") %>%
  dplyr::select(PATIENT_ID, PAT_FLAG_TYPE_C) %>%
  filter(PAT_FLAG_TYPE_C %in% c(2108, 2109, 2110)) %>%
  collect()

```


```{r Anthem Visit Volume 2025 vs. 2026}


date_start_2025 <- format(as.Date("2025-01-06"), "%Y-%m-%d")
date_end_2025 <- format(as.Date(paste0("2025-",format(Sys.Date(), "%m-%d"))), "%Y-%m-%d")

date_start_2026 <- format(as.Date("2026-01-05"), "%Y-%m-%d")
date_end_2026 <- format(Sys.Date()-1, "%Y-%m-%d")


# jan_vol_plans <- jan_vol %>%
#   left_join(anthem_plans2,
#             by = c("VISITPLAN" = "BENEFIT_PLAN_NAME"))



volume_comparison_check <- access_raw_tbl %>%
  left_join(finclass_tbl %>% 
              filter(PRD_TYPE == "EXCHANGE") %>%
              dplyr::select(PLAN_NAME, PRD_TYPE) %>%
              distinct(), 
            by = c("VISITPLAN" = "PLAN_NAME")) %>%
  left_join(tbl(conn2, "PATIENT_FYI_FLAGS") %>%
              dplyr::select(PATIENT_ID, PAT_FLAG_TYPE_C) %>%
              filter(PAT_FLAG_TYPE_C %in% c(2108, 2109, 2110)),
            by = c("PAT_ID" = "PATIENT_ID")) %>%
  mutate(FINCLASS = case_when(PRD_TYPE == "EXCHANGE" ~ "EXCHANGE", TRUE ~ FINCLASS)) %>%
  mutate(MSS_GROUP = case_when(GROUP_NUM %in% mss_exclusion_list ~ "MSS", TRUE ~ "")) %>%
  mutate(ANTHEM = case_when(VISITPLAN %in% anthem_plan_list ~ "Anthem", TRUE ~ "")) %>%
  mutate(ANTHEM = case_when(VISITPLAN %in% anthem_mcr_adv_list ~ "MCR Advantage", TRUE ~ ANTHEM)) %>%
  filter(year(CONTACT_DATE)>=2024) %>%
  filter(DERIVED_STATUS_DESC == "Arrived") %>%
  filter((CONTACT_DATE >= TO_DATE(date_start_2025, "YYYY-MM-DD HH24:MI:SS") & CONTACT_DATE <= TO_DATE(date_end_2025, "YYYY-MM-DD HH24:MI:SS")) |
           (CONTACT_DATE >= TO_DATE(date_start_2026, "YYYY-MM-DD HH24:MI:SS") & CONTACT_DATE <= TO_DATE(date_end_2026, "YYYY-MM-DD HH24:MI:SS"))) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  group_by(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, DERIVED_STATUS_DESC,
           CONTACT_DATE, appt_year, appt_month, PAT_FLAG_TYPE_C, MSS_GROUP, ANTHEM) %>%
  summarise(total = n()) %>%
  collect()
  

volume_comparison2_group <- volume_comparison_check %>%
  mutate(appt_day = wday(CONTACT_DATE, label = TRUE)) %>%
  mutate(
    pat_group = case_when(
      ANTHEM == "Anthem" &
        is.na(MSS_GROUP) ~ "Anthem",
      
      ANTHEM == "MCR Advantage" &
        is.na(MSS_GROUP) ~ "Medicare_Advantage",

      !is.na(ANTHEM) &
        !is.na(MSS_GROUP) ~ "MSS_Attributed",

      TRUE ~ "Other_Payor"
    )
  )


volume_comparison_group_summary <- volume_comparison2_group %>%
  group_by(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, 
           appt_year, pat_group) %>%
  summarise(total = sum(total, na.rm = T))


volume_comparison_group_summary2 <- volume_comparison_group_summary %>%
  pivot_wider(names_from = c("pat_group","appt_year"),
              values_from = total) %>%
  mutate(Total_2025 = rowSums(across(contains("2025")), na.rm = TRUE),
         Total_2026 = rowSums(across(contains("2026")), na.rm = TRUE)) %>%
  rowwise() %>%
  mutate(Total_Var = Total_2026 - Total_2025,
         Anthem_Var = Anthem_2026 - Anthem_2025,
         Medicare_Advantage_Var = Medicare_Advantage_2026 - Medicare_Advantage_2025,
         MSS_Attributed_Var = MSS_Attributed_2026 - MSS_Attributed_2025,
         Other_Payor_Var = Other_Payor_2026 - Other_Payor_2025,
         Total_Var_Perc = Total_Var / Total_2025,
         Anthem_Var_Perc = Anthem_Var / Anthem_2025,
         Medicare_Advantage_Var_Perc = Medicare_Advantage_Var / Medicare_Advantage_2025,
         MSS_Attributed_Var_Perc = MSS_Attributed_Var / MSS_Attributed_2025,
         Other_Payor_Var_Perc = Other_Payor_Var / Other_Payor_2025) %>%
  mutate(MSHS = "MSHS")
  

col_order <- c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "DEPARTMENT_ID",
               "Total_2025", "Anthem_2025", "Medicare_Advantage_2025", "MSS_Attributed_2025", "Other_Payor_2025",
               "Total_2026", "Anthem_2026", "Medicare_Advantage_2026", "MSS_Attributed_2026", "Other_Payor_2026",
               "Total_Var", "Anthem_Var", "Medicare_Advantage_Var", "MSS_Attributed_Var", "Other_Payor_Var",
               "Total_Var_Perc", "Anthem_Var_Perc", "Medicare_Advantage_Var_Perc", "MSS_Attributed_Var_Perc", "Other_Payor_Var_Perc")

volume_comparison_group_summary2 <- volume_comparison_group_summary2 %>%
  dplyr::select(col_order)


appt_day_comparison <- volume_comparison2_group %>%
  group_by(appt_year, appt_day) %>%
  summarise(total = n_distinct(CONTACT_DATE)) %>%
  pivot_wider(names_from = appt_day,
              values_from = total)

```


```{r Current and Next 14 Days Volume}

volume_comparison <- access_raw_tbl %>%
  left_join(finclass_tbl %>% 
              filter(PRD_TYPE == "EXCHANGE") %>%
              dplyr::select(PLAN_NAME, PRD_TYPE) %>%
              distinct(), 
            by = c("VISITPLAN" = "PLAN_NAME")) %>%
  left_join(tbl(conn2, "PATIENT_FYI_FLAGS") %>%
              dplyr::select(PATIENT_ID, PAT_FLAG_TYPE_C) %>%
              filter(PAT_FLAG_TYPE_C %in% c(2108, 2109, 2110)),
            by = c("PAT_ID" = "PATIENT_ID")) %>%
  mutate(FINCLASS = case_when(PRD_TYPE == "EXCHANGE" ~ "EXCHANGE", TRUE ~ FINCLASS)) %>%
  mutate(MSS_GROUP = case_when(GROUP_NUM %in% mss_exclusion_list ~ "MSS", TRUE ~ "")) %>%
  mutate(ANTHEM = case_when(VISITPLAN %in% anthem_plan_list ~ "Anthem", TRUE ~ "")) %>%
  mutate(ANTHEM = case_when(VISITPLAN %in% anthem_mcr_adv_list ~ "MCR Advantage", TRUE ~ ANTHEM)) %>%
  filter(year(CONTACT_DATE)>=2026) %>%
  filter(DERIVED_STATUS_DESC %in% c("Arrived", "Scheduled")) %>%
  filter((CONTACT_DATE <= TO_DATE(date_next_14days, "YYYY-MM-DD HH24:MI:SS"))) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE)) %>%
  group_by(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, DERIVED_STATUS_DESC,
           CONTACT_DATE, appt_year, appt_month, PAT_FLAG_TYPE_C, MSS_GROUP, ANTHEM) %>%
  summarise(total = n()) %>%
  collect()
  
  
volume_comparison2_CoC <- volume_comparison %>%
  mutate(appt_day = wday(CONTACT_DATE, label = TRUE)) %>%
  mutate(period = case_when(CONTACT_DATE < date_start ~ "past", TRUE ~ "future")) %>%
  mutate(
    pat_group = case_when(
      
      !is.na(ANTHEM) &
        !is.na(MSS_GROUP) ~ "MSS_Attributed",
      
      !is.na(ANTHEM) &
        PAT_FLAG_TYPE_C %in% c("2108", "2109") ~ "CoC",

      !is.na(ANTHEM) &
        !PAT_FLAG_TYPE_C %in% c("2108", "2109") ~ "Non_CoC",

      TRUE ~ "Other_Payor"
    )
  )


volume_comparison_CoC_summary <- volume_comparison2_CoC %>%
  group_by(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, 
           period, pat_group) %>%
  summarise(total = sum(total, na.rm = T))


volume_comparison_CoC_summary2 <- volume_comparison_CoC_summary %>%
  pivot_wider(names_from = c("pat_group","period"),
              values_from = total) %>%
  mutate(Total_past = rowSums(across(contains("past")), na.rm = TRUE),
         Total_future = rowSums(across(contains("future")), na.rm = TRUE)) %>%
  rowwise() %>%
  mutate(Total_past_perc = Total_past / Total_past,
         CoC_past_perc = CoC_past / Total_past,
         Non_CoC_past_perc = Non_CoC_past / Total_past,
         MSS_Attributed_past_perc = MSS_Attributed_past / Total_past,
         Other_Payor_past_perc = Other_Payor_past / Total_past,
         Total_future_perc = Total_future / Total_future,
         CoC_future_perc = CoC_future / Total_future,
         Non_CoC_future_perc = Non_CoC_future / Total_future,
         MSS_Attributed_future_perc = MSS_Attributed_future / Total_future,
         Other_Payor_future_perc = Other_Payor_future / Total_future
         ) %>%
  mutate(MSHS = "MSHS")
  

col_order <- c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "DEPARTMENT_ID",
               "Total_past", "CoC_past", "Non_CoC_past", "MSS_Attributed_past", "Other_Payor_past",
               "Total_past_perc", "CoC_past_perc", "Non_CoC_past_perc", "MSS_Attributed_past_perc", "Other_Payor_past_perc",
               "Total_future", "CoC_future", "Non_CoC_future", "MSS_Attributed_future", "Other_Payor_future",
               "Total_future_perc", "CoC_future_perc", "Non_CoC_future_perc", "MSS_Attributed_future_perc", "Other_Payor_future_perc")

volume_comparison_CoC_summary2 <- volume_comparison_CoC_summary2 %>%
  dplyr::select(col_order)


```



```{r Sinai Logo, echo=FALSE, out.width = '15%'}
knitr::include_graphics("Mount_Sinai_Logo_H.png")
```


# Anthem Volume Impact {.tabset .tabset-fade .tabset-pills}
*Report run date: `r report_run_date`*<br/>
______________________________________________________________________________________________________________________________
<br/>
<br/>


<!-- ## Volume Comparison  -->
<!-- ```{r Volume Comparison by Group All, echo = FALSE, warning = FALSE, message = FALSE} -->


<!-- htmltools::browsable( -->
<!--   tagList( -->
<!--     tags$button( -->
<!--       tagList(fontawesome::fa("download"), "Download Table"), -->
<!--       onclick = "Reactable.downloadDataCSV('anthem-volume', 'Anthem Volume Impact')" -->
<!--     ), -->

<!-- # htmltools::browsable( -->
<!-- #   tagList( -->
<!-- #     div(tags$label("Summary by", `for` = "access-roi")), -->
<!-- #     tags$select( -->
<!-- #       id = "access-roi", -->
<!-- #       onchange = "Reactable.setGroupBy('access-metrics', this.value ? [this.value] : [])", -->
<!-- #       tags$option("None", value = ""), -->
<!-- #       lapply(c("Year", "Month"), tags$option) -->
<!-- #     ), -->
<!-- #  -->
<!-- #     tags$hr("aria-hidden" = "true"), -->

<!-- reactable( -->
<!--   volume_comparison_group_summary2, -->
<!--   elementId = "anthem-volume", -->
<!--   # elementId = "referral-vol-download-table", -->
<!--   style = list(fontFamily = 'Calibri', -->
<!--                  fontSize = '14px'), -->
<!--     defaultColDef = colDef(align = "left", -->
<!--                            headerStyle = list(fontWeight = "Bold", fontSize = "14px"), -->
<!--                            headerClass = "bar-sort-header"), -->
<!--   # RowStyle = function(index) { -->
<!--   #           if (index %in% c(nrow(referral_vol_site_data_mshs))) { -->
<!--   #             list(`border-top` = "2px solid rgb(184,184,184)", -->
<!--   #                  fontWeight = "Bold") -->
<!--   #           } -->
<!--   #         }, -->
<!--     highlight = TRUE, -->
<!--     # filterable = TRUE, -->
<!--     pagination = FALSE, -->
<!--     # height = 800, -->
<!--     wrap = TRUE, -->
<!--   searchable = TRUE, -->

<!--   groupBy = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME"), -->

<!--   columnGroups = list( -->
<!--     colGroup(name = "", columns = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "DEPARTMENT_ID"), -->
<!--              headerStyle = list(color = "black", fontSize = "15px"), -->
<!--              sticky = "left"), -->
<!--     colGroup(name = paste0("2025 Completed Visits (", format(as.Date(date_start_2025), "%m/%d"),"-",format(as.Date(date_end_2025), "%m/%d"),")"), -->
<!--              columns = c("Total_2025", "Anthem_2025", "Medicare_Advantage_2025", "MSS_Attributed_2025", "Other_Payor_2025"), -->
<!--              headerStyle = list(background = "#7f7f7f", color = "white", fontSize = "15px")), -->
<!--     colGroup(name = paste0("2026 Completed Visits (", format(as.Date(date_start_2026), "%m/%d"),"-",format(as.Date(date_end_2026), "%m/%d"),")"), -->
<!--              columns = c("Total_2026", "Anthem_2026", "Medicare_Advantage_2026", "MSS_Attributed_2026", "Other_Payor_2026"), -->
<!--              headerStyle = list(background = "#212070", color = "white", fontSize = "15px")), -->
<!--     colGroup(name = paste0("Volume Variance"), -->
<!--              columns = c("Total_Var", "Anthem_Var", "Medicare_Advantage_Var", "MSS_Attributed_Var", "Other_Payor_Var"), -->
<!--              headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px")), -->
<!--     colGroup(name = paste0("Volume Variance %"), -->
<!--              columns = c("Total_Var_Perc", "Anthem_Var_Perc", "Medicare_Advantage_Var_Perc", "MSS_Attributed_Var_Perc", "Other_Payor_Var_Perc"), -->
<!--              headerStyle = list(background = "#00aeef", color = "white", fontSize = "15px")) -->
<!--     # colGroup(name = paste0("New Patient Capture*"), -->
<!--     #          columns = c("NEW_LOS", "NEW_LOS_baseline", "new_pt_var_baseline", -->
<!--     #                      "perc_new_los", "perc_new_los_baseline", "perc_new_los_var_baseline", -->
<!--     #                      "perc_new_pt_target", "perc_new_los_var_target"), -->
<!--     #          headerStyle = list(background = "#a5a7a5", color = "white", fontSize = "15px")) -->
<!--     ), -->

<!--   columns = list( -->

<!--      MSHS = colDef( -->
<!--       name = "MSHS", -->
<!--       maxWidth = 100), -->

<!--      SITE = colDef( -->
<!--       name = "Site", -->
<!--       minWidth = 200), -->

<!--      DEPT_SPECIALTY_NAME = colDef( -->
<!--       name = "Specialty", -->
<!--       minWidth = 200), -->

<!--      DEPARTMENT_NAME = colDef( -->
<!--       name = "Department", -->
<!--       minWidth = 200), -->

<!--      DEPARTMENT_ID = colDef( -->
<!--       name = "Department ID", -->
<!--       minWidth = 120), -->

<!--      Total_2025 = colDef( -->
<!--       name = "Total", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = 'sum', -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      Anthem_2025 = colDef( -->
<!--       name = "Anthem", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = 'sum', -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      Medicare_Advantage_2025 = colDef( -->
<!--       name = "Medicare Advantage", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = 'sum', -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      MSS_Attributed_2025 = colDef( -->
<!--       name = "MSS Attributed", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = 'sum', -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      Other_Payor_2025 = colDef( -->
<!--       name = "Other Payor", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = 'sum', -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      Total_2026 = colDef( -->
<!--       name = "Total", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = 'sum', -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      Anthem_2026 = colDef( -->
<!--       name = "Anthem", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = 'sum', -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      Medicare_Advantage_2026 = colDef( -->
<!--       name = "Medicare Advantage", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = 'sum', -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      MSS_Attributed_2026 = colDef( -->
<!--       name = "MSS Attributed", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = 'sum', -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      Other_Payor_2026 = colDef( -->
<!--       name = "Other Payor", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = 'sum', -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      Total_Var = colDef( -->
<!--       name = "Total", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalTotal_2025 = 0 -->
<!--         let totalTotal_2026 = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalTotal_2025 += row['Total_2025'] -->
<!--           totalTotal_2026 += row['Total_2026'] -->
<!--         }) -->
<!--         return (totalTotal_2026 - totalTotal_2025) || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['Total_Var'] -->
<!--         if (value > 0) { -->
<!--           var color = '#008000' -->
<!--         } else { -->
<!--           var color = ' #e00000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      Anthem_Var = colDef( -->
<!--       name = "Anthem", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalAnthem_2025 = 0 -->
<!--         let totalAnthem_2026 = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalAnthem_2025 += row['Anthem_2025'] -->
<!--           totalAnthem_2026 += row['Anthem_2026'] -->
<!--         }) -->
<!--         return (totalAnthem_2026 - totalAnthem_2025) || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['Anthem_Var'] -->
<!--         if (value > 0) { -->
<!--           var color = '#008000' -->
<!--         } else { -->
<!--           var color = ' #e00000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      Medicare_Advantage_Var = colDef( -->
<!--       name = "Medicare Advantage", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalMedicare_Advantage_2025 = 0 -->
<!--         let totalMedicare_Advantage_2026 = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalMedicare_Advantage_2025 += row['Medicare_Advantage_2025'] -->
<!--           totalMedicare_Advantage_2026 += row['Medicare_Advantage_2026'] -->
<!--         }) -->
<!--         return (totalMedicare_Advantage_2026 - totalMedicare_Advantage_2025) || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['Medicare_Advantage_Var'] -->
<!--         if (value > 0) { -->
<!--           var color = '#008000' -->
<!--         } else { -->
<!--           var color = ' #e00000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      MSS_Attributed_Var = colDef( -->
<!--       name = "MSS Attributed", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalMSS_Attributed_2025 = 0 -->
<!--         let totalMSS_Attributed_2026 = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalMSS_Attributed_2025 += row['MSS_Attributed_2025'] -->
<!--           totalMSS_Attributed_2026 += row['MSS_Attributed_2026'] -->
<!--         }) -->
<!--         return (totalMSS_Attributed_2026 - totalMSS_Attributed_2025) || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['MSS_Attributed_Var'] -->
<!--         if (value > 0) { -->
<!--           var color = '#008000' -->
<!--         } else { -->
<!--           var color = ' #e00000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      Other_Payor_Var = colDef( -->
<!--       name = "Other Payor", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalOther_Payor_2025 = 0 -->
<!--         let totalOther_Payor_2026 = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalOther_Payor_2025 += row['Other_Payor_2025'] -->
<!--           totalOther_Payor_2026 += row['Other_Payor_2026'] -->
<!--         }) -->
<!--         return (totalOther_Payor_2026 - totalOther_Payor_2025) || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['Other_Payor_Var'] -->
<!--         if (value > 0) { -->
<!--           var color = '#008000' -->
<!--         } else { -->
<!--           var color = ' #e00000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(separators = TRUE, digits = 0)), -->

<!--      Total_Var_Perc = colDef( -->
<!--       name = "Total", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalTotal_2025 = 0 -->
<!--         let totalTotal_2026 = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalTotal_2025 += row['Total_2025'] -->
<!--           totalTotal_2026 += row['Total_2026'] -->
<!--         }) -->
<!--         return (totalTotal_2026 - totalTotal_2025) / totalTotal_2025 || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['Total_Var_Perc'] -->
<!--         if (value > 0) { -->
<!--           var color = '#008000' -->
<!--         } else { -->
<!--           var color = ' #e00000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1)), -->

<!--      Anthem_Var_Perc = colDef( -->
<!--       name = "Anthem", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalAnthem_2025 = 0 -->
<!--         let totalAnthem_2026 = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalAnthem_2025 += row['Anthem_2025'] -->
<!--           totalAnthem_2026 += row['Anthem_2026'] -->
<!--         }) -->
<!--         return (totalAnthem_2026 - totalAnthem_2025) / totalAnthem_2025 || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['Anthem_Var_Perc'] -->
<!--         if (value > 0) { -->
<!--           var color = '#008000' -->
<!--         } else { -->
<!--           var color = ' #e00000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1)), -->

<!--      Medicare_Advantage_Var_Perc = colDef( -->
<!--       name = "Medicare Advantage", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalMedicare_Advantage_2025 = 0 -->
<!--         let totalMedicare_Advantage_2026 = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalMedicare_Advantage_2025 += row['Medicare_Advantage_2025'] -->
<!--           totalMedicare_Advantage_2026 += row['Medicare_Advantage_2026'] -->
<!--         }) -->
<!--         return (totalMedicare_Advantage_2026 - totalMedicare_Advantage_2025) / totalMedicare_Advantage_2025 || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['Medicare_Advantage_Var_Perc'] -->
<!--         if (value > 0) { -->
<!--           var color = '#008000' -->
<!--         } else { -->
<!--           var color = ' #e00000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1)), -->

<!--      MSS_Attributed_Var_Perc = colDef( -->
<!--       name = "MSS Attributed", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalMSS_Attributed_2025 = 0 -->
<!--         let totalMSS_Attributed_2026 = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalMSS_Attributed_2025 += row['MSS_Attributed_2025'] -->
<!--           totalMSS_Attributed_2026 += row['MSS_Attributed_2026'] -->
<!--         }) -->
<!--         return (totalMSS_Attributed_2026 - totalMSS_Attributed_2025) / totalMSS_Attributed_2025 || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['MSS_Attributed_Var_Perc'] -->
<!--         if (value > 0) { -->
<!--           var color = '#008000' -->
<!--         } else { -->
<!--           var color = ' #e00000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1)), -->

<!--      Other_Payor_Var_Perc = colDef( -->
<!--       name = "Other Payor", -->
<!--       maxWidth = 80, -->
<!--       headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"), -->
<!--       aggregate = JS("function(values, rows) { -->
<!--         let totalOther_Payor_2025 = 0 -->
<!--         let totalOther_Payor_2026 = 0 -->
<!--         rows.forEach(function(row) { -->
<!--           totalOther_Payor_2025 += row['Other_Payor_2025'] -->
<!--           totalOther_Payor_2026 += row['Other_Payor_2026'] -->
<!--         }) -->
<!--         return (totalOther_Payor_2026 - totalOther_Payor_2025) / totalOther_Payor_2025 || '-' -->
<!--       }"), -->
<!--       style = JS("function(rowInfo) { -->
<!--         var value = rowInfo.row['Other_Payor_Var_Perc'] -->
<!--         if (value > 0) { -->
<!--           var color = '#008000' -->
<!--         } else { -->
<!--           var color = ' #e00000' -->
<!--         } -->
<!--         return { color: color, fontFamily: 'calibri', fontWeight: 'bold'} -->
<!--       }"), -->
<!--       format = colFormat(percent = TRUE, digits = 1)) -->

<!--   ) # Close Columns -->

<!--   ) # Close Reactable -->
<!-- ) # Close Taglist -->
<!-- ) # Close htmltools -->

<!-- ``` -->


## Anthem Volume Impact
```{r Volume Comparison by Group Sites Only, echo = FALSE, warning = FALSE, message = FALSE}


htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('anthem-volume-sites', 'Anthem Volume Impact (Sites)')"
    ),

# htmltools::browsable(
#   tagList(
#     div(tags$label("Summary by", `for` = "access-roi")),
#     tags$select(
#       id = "access-roi",
#       onchange = "Reactable.setGroupBy('access-metrics', this.value ? [this.value] : [])",
#       tags$option("None", value = ""),
#       lapply(c("Year", "Month"), tags$option)
#     ),
# 
#     tags$hr("aria-hidden" = "true"),
    
reactable(
  volume_comparison_group_summary2 %>%
    filter(SITE %in% c("MSBI", "MSDMG", "MSH- AMBULATORY CARE", "MSH-MSDFP", "MSM", "MSQ",
                       "MSUS", "MSW", "NETWORK", "NYEE", "MSB")),
  elementId = "anthem-volume-sites",
  # elementId = "referral-vol-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME"),

  columnGroups = list(
    colGroup(name = "", columns = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "DEPARTMENT_ID"),
             headerStyle = list(color = "black", fontSize = "15px"),
             sticky = "left"),
    colGroup(name = paste0("2025 Completed Visits (", format(as.Date(date_start_2025), "%m/%d"),"-",format(as.Date(date_end_2025), "%m/%d"),")"),
             columns = c("Total_2025", "Anthem_2025", "Medicare_Advantage_2025", "MSS_Attributed_2025", "Other_Payor_2025"),
             headerStyle = list(background = "#7f7f7f", color = "white", fontSize = "15px")),
    colGroup(name = paste0("2026 Completed Visits (", format(as.Date(date_start_2026), "%m/%d"),"-",format(as.Date(date_end_2026), "%m/%d"),")"),
             columns = c("Total_2026", "Anthem_2026", "Medicare_Advantage_2026", "MSS_Attributed_2026", "Other_Payor_2026"),
             headerStyle = list(background = "#212070", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Volume Variance"),
             columns = c("Total_Var", "Anthem_Var", "Medicare_Advantage_Var", "MSS_Attributed_Var", "Other_Payor_Var"),
             headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Volume Variance %"),
             columns = c("Total_Var_Perc", "Anthem_Var_Perc", "Medicare_Advantage_Var_Perc", "MSS_Attributed_Var_Perc", "Other_Payor_Var_Perc"),
             headerStyle = list(background = "#00aeef", color = "white", fontSize = "15px"))
    # colGroup(name = paste0("New Patient Capture*"),
    #          columns = c("NEW_LOS", "NEW_LOS_baseline", "new_pt_var_baseline",
    #                      "perc_new_los", "perc_new_los_baseline", "perc_new_los_var_baseline",
    #                      "perc_new_pt_target", "perc_new_los_var_target"),
    #          headerStyle = list(background = "#a5a7a5", color = "white", fontSize = "15px"))
    ),

  columns = list(

     MSHS = colDef(
      name = "MSHS",
      maxWidth = 100),
     
     SITE = colDef(
      name = "Site",
      minWidth = 200),
     
     DEPT_SPECIALTY_NAME = colDef(
      name = "Specialty",
      minWidth = 200),
     
     DEPARTMENT_NAME = colDef(
      name = "Department",
      minWidth = 200),
     
     DEPARTMENT_ID = colDef(
      name = "Department ID",
      minWidth = 120),
     
     Total_2025 = colDef(
      name = "Total",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     Anthem_2025 = colDef(
      name = "Anthem",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     Medicare_Advantage_2025 = colDef(
      name = "Medicare Advantage",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     MSS_Attributed_2025 = colDef(
      name = "MSS Attributed",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),

     Other_Payor_2025 = colDef(
      name = "Other Payor",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     Total_2026 = colDef(
      name = "Total",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     Anthem_2026 = colDef(
      name = "Anthem",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     Medicare_Advantage_2026 = colDef(
      name = "Medicare Advantage",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     MSS_Attributed_2026 = colDef(
      name = "MSS Attributed",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),

     Other_Payor_2026 = colDef(
      name = "Other Payor",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     Total_Var = colDef(
      name = "Total",
      maxWidth = 80,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_2025 = 0
        let totalTotal_2026 = 0
        rows.forEach(function(row) {
          totalTotal_2025 += row['Total_2025']
          totalTotal_2026 += row['Total_2026']
        })
        return (totalTotal_2026 - totalTotal_2025) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['Total_Var']
        if (value > 0) {
          var color = '#008000'
        } else {
          var color = ' #e00000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(separators = TRUE, digits = 0)),
     
     Anthem_Var = colDef(
      name = "Anthem",
      maxWidth = 80,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalAnthem_2025 = 0
        let totalAnthem_2026 = 0
        rows.forEach(function(row) {
          totalAnthem_2025 += row['Anthem_2025']
          totalAnthem_2026 += row['Anthem_2026']
        })
        return (totalAnthem_2026 - totalAnthem_2025) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['Anthem_Var']
        if (value > 0) {
          var color = '#008000'
        } else {
          var color = ' #e00000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(separators = TRUE, digits = 0)),
     
     Medicare_Advantage_Var = colDef(
      name = "Medicare Advantage",
      maxWidth = 80,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalMedicare_Advantage_2025 = 0
        let totalMedicare_Advantage_2026 = 0
        rows.forEach(function(row) {
          totalMedicare_Advantage_2025 += row['Medicare_Advantage_2025']
          totalMedicare_Advantage_2026 += row['Medicare_Advantage_2026']
        })
        return (totalMedicare_Advantage_2026 - totalMedicare_Advantage_2025) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['Medicare_Advantage_Var']
        if (value > 0) {
          var color = '#008000'
        } else {
          var color = ' #e00000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(separators = TRUE, digits = 0)),
     
     MSS_Attributed_Var = colDef(
      name = "MSS Attributed",
      maxWidth = 80,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalMSS_Attributed_2025 = 0
        let totalMSS_Attributed_2026 = 0
        rows.forEach(function(row) {
          totalMSS_Attributed_2025 += row['MSS_Attributed_2025']
          totalMSS_Attributed_2026 += row['MSS_Attributed_2026']
        })
        return (totalMSS_Attributed_2026 - totalMSS_Attributed_2025) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['MSS_Attributed_Var']
        if (value > 0) {
          var color = '#008000'
        } else {
          var color = ' #e00000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(separators = TRUE, digits = 0)),
     
     Other_Payor_Var = colDef(
      name = "Other Payor",
      maxWidth = 80,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalOther_Payor_2025 = 0
        let totalOther_Payor_2026 = 0
        rows.forEach(function(row) {
          totalOther_Payor_2025 += row['Other_Payor_2025']
          totalOther_Payor_2026 += row['Other_Payor_2026']
        })
        return (totalOther_Payor_2026 - totalOther_Payor_2025) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['Other_Payor_Var']
        if (value > 0) {
          var color = '#008000'
        } else {
          var color = ' #e00000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(separators = TRUE, digits = 0)),
     
     Total_Var_Perc = colDef(
      name = "Total",
      maxWidth = 80,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_2025 = 0
        let totalTotal_2026 = 0
        rows.forEach(function(row) {
          totalTotal_2025 += row['Total_2025']
          totalTotal_2026 += row['Total_2026']
        })
        return (totalTotal_2026 - totalTotal_2025) / totalTotal_2025 || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['Total_Var_Perc']
        if (value > 0) {
          var color = '#008000'
        } else {
          var color = ' #e00000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)),
     
     Anthem_Var_Perc = colDef(
      name = "Anthem",
      maxWidth = 80,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalAnthem_2025 = 0
        let totalAnthem_2026 = 0
        rows.forEach(function(row) {
          totalAnthem_2025 += row['Anthem_2025']
          totalAnthem_2026 += row['Anthem_2026']
        })
        return (totalAnthem_2026 - totalAnthem_2025) / totalAnthem_2025 || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['Anthem_Var_Perc']
        if (value > 0) {
          var color = '#008000'
        } else {
          var color = ' #e00000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)),
     
     Medicare_Advantage_Var_Perc = colDef(
      name = "Medicare Advantage",
      maxWidth = 80,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalMedicare_Advantage_2025 = 0
        let totalMedicare_Advantage_2026 = 0
        rows.forEach(function(row) {
          totalMedicare_Advantage_2025 += row['Medicare_Advantage_2025']
          totalMedicare_Advantage_2026 += row['Medicare_Advantage_2026']
        })
        return (totalMedicare_Advantage_2026 - totalMedicare_Advantage_2025) / totalMedicare_Advantage_2025 || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['Medicare_Advantage_Var_Perc']
        if (value > 0) {
          var color = '#008000'
        } else {
          var color = ' #e00000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)),
     
     MSS_Attributed_Var_Perc = colDef(
      name = "MSS Attributed",
      maxWidth = 80,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalMSS_Attributed_2025 = 0
        let totalMSS_Attributed_2026 = 0
        rows.forEach(function(row) {
          totalMSS_Attributed_2025 += row['MSS_Attributed_2025']
          totalMSS_Attributed_2026 += row['MSS_Attributed_2026']
        })
        return (totalMSS_Attributed_2026 - totalMSS_Attributed_2025) / totalMSS_Attributed_2025 || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['MSS_Attributed_Var_Perc']
        if (value > 0) {
          var color = '#008000'
        } else {
          var color = ' #e00000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)),
     
     Other_Payor_Var_Perc = colDef(
      name = "Other Payor",
      maxWidth = 80,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalOther_Payor_2025 = 0
        let totalOther_Payor_2026 = 0
        rows.forEach(function(row) {
          totalOther_Payor_2025 += row['Other_Payor_2025']
          totalOther_Payor_2026 += row['Other_Payor_2026']
        })
        return (totalOther_Payor_2026 - totalOther_Payor_2025) / totalOther_Payor_2025 || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['Other_Payor_Var_Perc']
        if (value > 0) {
          var color = '#008000'
        } else {
          var color = ' #e00000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1))
     
  ) # Close Columns

  ) # Close Reactable
) # Close Taglist
) # Close htmltools

```


## Completed and Scheduled Appts
```{r Volume Past and Future All, echo = FALSE, warning = FALSE, message = FALSE}


htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('anthem-appts-all', 'Anthem Appointments')"
    ),

# htmltools::browsable(
#   tagList(
#     div(tags$label("Summary by", `for` = "access-roi")),
#     tags$select(
#       id = "access-roi",
#       onchange = "Reactable.setGroupBy('access-metrics', this.value ? [this.value] : [])",
#       tags$option("None", value = ""),
#       lapply(c("Year", "Month"), tags$option)
#     ),
#
#     tags$hr("aria-hidden" = "true"),

reactable(
  volume_comparison_CoC_summary2,
  elementId = "anthem-appts-all",
  # elementId = "referral-vol-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME"),

  columnGroups = list(
    colGroup(name = "", columns = c("MSHS", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "DEPARTMENT_ID"),
             headerStyle = list(color = "black", fontSize = "15px"),
             sticky = "left"),
    colGroup(name = paste0("2026 Completed Visits (", format(as.Date("2026-01-01"), "%m/%d"),"-",format(as.Date(date_end_2026), "%m/%d"),")"),
             columns = c("Total_past", "CoC_past", "Non_CoC_past", "MSS_Attributed_past", "Other_Payor_past",
                         "Total_past_perc", "CoC_past_perc", "Non_CoC_past_perc", "MSS_Attributed_past_perc", "Other_Payor_past_perc"),
             headerStyle = list(background = "#7f7f7f", color = "white", fontSize = "15px")),
    colGroup(name = paste0("2026 Scheduled Visits Next 14 Days (", format(as.Date(report_run_date), "%m/%d"),"-",format(as.Date(date_next_14days), "%m/%d"),")"),
             columns = c("Total_future", "CoC_future", "Non_CoC_future", "MSS_Attributed_future", "Other_Payor_future",
                         "Total_future_perc", "CoC_future_perc", "Non_CoC_future_perc", "MSS_Attributed_future_perc", "Other_Payor_future_perc"),
             headerStyle = list(background = "#212070", color = "white", fontSize = "15px"))
    # colGroup(name = paste0("Volume Variance"),
    #          columns = c("Total_Var", "CoC_Var", "Non_CoC_Var", "MSS_Attributed_Var", "Other_Payor_Var"),
    #          headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px")),
    # colGroup(name = paste0("Volume Variance %"),
    #          columns = c("Total_Var_Perc", "CoC_Var_Perc", "Non_CoC_Var_Perc", "MSS_Attributed_Var_Perc", "Other_Payor_Var_Perc"),
    #          headerStyle = list(background = "#00aeef", color = "white", fontSize = "15px"))
    # colGroup(name = paste0("New Patient Capture*"),
    #          columns = c("NEW_LOS", "NEW_LOS_baseline", "new_pt_var_baseline",
    #                      "perc_new_los", "perc_new_los_baseline", "perc_new_los_var_baseline",
    #                      "perc_new_pt_target", "perc_new_los_var_target"),
    #          headerStyle = list(background = "#a5a7a5", color = "white", fontSize = "15px"))
    ),

  columns = list(

     MSHS = colDef(
      name = "MSHS",
      maxWidth = 100),

     SITE = colDef(
      name = "Site",
      minWidth = 200),

     DEPT_SPECIALTY_NAME = colDef(
      name = "Specialty",
      minWidth = 200),

     DEPARTMENT_NAME = colDef(
      name = "Department",
      minWidth = 200),

     DEPARTMENT_ID = colDef(
      name = "Department ID",
      minWidth = 120),

     Total_past = colDef(
      name = "Total",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),

     CoC_past = colDef(
      name = "CoC",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),

     Non_CoC_past = colDef(
      name = "Non-CoC",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),

     MSS_Attributed_past = colDef(
      name = "MSS Attributed",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),

     Other_Payor_past = colDef(
      name = "Other Payor",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     Total_past_perc = colDef(
      name = "% Total",
      maxWidth = 80,
      headerStyle = list(background = "#A3A3A3", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_past = 0
        rows.forEach(function(row) {
          totalTotal_past += row['Total_past']
        })
        return (totalTotal_past / totalTotal_past) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0)),

     CoC_past_perc = colDef(
      name = "% CoC",
      maxWidth = 80,
      headerStyle = list(background = "#A3A3A3", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_past = 0
        let totalCoC_past = 0
        rows.forEach(function(row) {
          totalTotal_past += row['Total_past']
          totalCoC_past += row['CoC_past']
        })
        return (totalCoC_past / totalTotal_past) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0)),

     Non_CoC_past_perc = colDef(
      name = "% Non-CoC",
      maxWidth = 80,
      headerStyle = list(background = "#A3A3A3", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_past = 0
        let totalNon_CoC_past = 0
        rows.forEach(function(row) {
          totalTotal_past += row['Total_past']
          totalNon_CoC_past += row['Non_CoC_past']
        })
        return (totalNon_CoC_past / totalTotal_past) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0)),

     MSS_Attributed_past_perc = colDef(
      name = "% MSS Attributed",
      maxWidth = 80,
      headerStyle = list(background = "#A3A3A3", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_past = 0
        let totalMSS_Attributed_past = 0
        rows.forEach(function(row) {
          totalTotal_past += row['Total_past']
          totalMSS_Attributed_past += row['MSS_Attributed_past']
        })
        return (totalMSS_Attributed_past / totalTotal_past) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0)),

     Other_Payor_past_perc = colDef(
      name = "% Other Payor",
      maxWidth = 80,
      headerStyle = list(background = "#A3A3A3", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_past = 0
        let totalOther_Payor_past = 0
        rows.forEach(function(row) {
          totalTotal_past += row['Total_past']
          totalOther_Payor_past += row['Other_Payor_past']
        })
        return (totalOther_Payor_past / totalTotal_past) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0)),

     Total_future = colDef(
      name = "Total",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),

     CoC_future = colDef(
      name = "CoC",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),

     Non_CoC_future = colDef(
      name = "Non-CoC",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),

     MSS_Attributed_future = colDef(
      name = "MSS Attributed",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),

     Other_Payor_future = colDef(
      name = "Other Payor",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),


     Total_future_perc = colDef(
      name = "% Total",
      maxWidth = 80,
      headerStyle = list(background = "#5552CE", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_future = 0
        rows.forEach(function(row) {
          totalTotal_future += row['Total_future']
        })
        return (totalTotal_future / totalTotal_future) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0)),

     CoC_future_perc = colDef(
      name = "% CoC",
      maxWidth = 80,
      headerStyle = list(background = "#5552CE", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_future = 0
        let totalCoC_future = 0
        rows.forEach(function(row) {
          totalTotal_future += row['Total_future']
          totalCoC_future += row['CoC_future']
        })
        return (totalCoC_future / totalTotal_future) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0)),

     Non_CoC_future_perc = colDef(
      name = "% Non-CoC",
      maxWidth = 80,
      headerStyle = list(background = "#5552CE", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_future = 0
        let totalNon_CoC_future = 0
        rows.forEach(function(row) {
          totalTotal_future += row['Total_future']
          totalNon_CoC_future += row['Non_CoC_future']
        })
        return (totalNon_CoC_future / totalTotal_future) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0)),

     MSS_Attributed_future_perc = colDef(
      name = "% MSS Attributed",
      maxWidth = 80,
      headerStyle = list(background = "#5552CE", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_future = 0
        let totalMSS_Attributed_future = 0
        rows.forEach(function(row) {
          totalTotal_future += row['Total_future']
          totalMSS_Attributed_future += row['MSS_Attributed_future']
        })
        return (totalMSS_Attributed_future / totalTotal_future) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0)),

     Other_Payor_future_perc = colDef(
      name = "% Other Payor",
      maxWidth = 80,
      headerStyle = list(background = "#5552CE", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_future = 0
        let totalOther_Payor_future = 0
        rows.forEach(function(row) {
          totalTotal_future += row['Total_future']
          totalOther_Payor_future += row['Other_Payor_future']
        })
        return (totalOther_Payor_future / totalTotal_future) || '-'
      }"),
      format = colFormat(percent = TRUE, digits = 0))

     

  ) # Close Columns

  ) # Close Reactable
) # Close Taglist
) # Close htmltools

```


```{r No Show Rate}

no_show <- access_raw_tbl %>%
  left_join(finclass_tbl %>% 
              filter(PRD_TYPE == "EXCHANGE") %>%
              dplyr::select(PLAN_NAME, PRD_TYPE) %>%
              distinct(), 
            by = c("VISITPLAN" = "PLAN_NAME")) %>%
  left_join(tbl(conn2, "PATIENT_FYI_FLAGS") %>%
              dplyr::select(PATIENT_ID, PAT_FLAG_TYPE_C) %>%
              filter(PAT_FLAG_TYPE_C %in% c(2108, 2109, 2110)),
            by = c("PAT_ID" = "PATIENT_ID")) %>%
  left_join(tbl(conn2, "CLARITY_SER") %>% select(PROV_ID, PROV_TYPE)) %>%
  mutate(FINCLASS = case_when(PRD_TYPE == "EXCHANGE" ~ "EXCHANGE", TRUE ~ FINCLASS)) %>%
  mutate(MSS_GROUP = case_when(GROUP_NUM %in% mss_exclusion_list ~ "MSS", TRUE ~ "")) %>%
  mutate(ANTHEM = case_when(VISITPLAN %in% anthem_plan_list ~ "Anthem", TRUE ~ "")) %>%
  filter(year(CONTACT_DATE)>=2026) %>%
  filter(CONTACT_DATE < TO_DATE(slot_date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>%
  mutate(cancel_lead_days = APPT_DTTM - APPT_CANC_DTTM) %>%
   filter(DERIVED_STATUS_DESC == "Arrived" | 
           DERIVED_STATUS_DESC == "No Show" |
           (DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <= 1) |
           (DERIVED_STATUS_DESC == "Rescheduled" & cancel_lead_days <= 1)) %>%
  mutate(appt_year = year(CONTACT_DATE),
         appt_month = month(CONTACT_DATE),
         appt_week = trunc(CONTACT_DATE, "IW")) %>% 
  mutate(appt_made_year = year(APPT_MADE_DATE),
         appt_made_month = month(APPT_MADE_DATE)) %>%
  mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>%
  mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>%
  group_by(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, PROV_TYPE, PROV_ID, PROV_NAME_WID, DERIVED_STATUS_DESC,
           CONTACT_DATE, appt_year, appt_month, appt_week, PAT_FLAG_TYPE_C, MSS_GROUP, ANTHEM) %>%
  summarise(total = n()) %>%
  collect() 


no_show2 <- no_show %>%
  mutate(appt_day = wday(CONTACT_DATE, label = TRUE)) %>%
  mutate(appt_status = case_when(DERIVED_STATUS_DESC == "Arrived" ~ "Arrived",
                                 TRUE ~ "NS_SDC")) %>%
  mutate(
    pat_group = case_when(
      
      !is.na(ANTHEM) &
        !is.na(MSS_GROUP) ~ "MSS_Attributed",
      
      !is.na(ANTHEM) &
        PAT_FLAG_TYPE_C %in% c("2108", "2109") ~ "CoC",

      !is.na(ANTHEM) &
        !PAT_FLAG_TYPE_C %in% c("2108", "2109") ~ "Non_CoC",

      TRUE ~ "Other_Payor"
    )
  )


no_show_summary <- no_show2  %>%
  group_by(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, 
           PROV_TYPE, PROV_ID, PROV_NAME_WID,
           appt_year, appt_month, appt_week, appt_status, pat_group) %>%
  summarise(total = sum(total, na.rm = T)) %>%
  pivot_wider(names_from = c("pat_group","appt_status"),
              values_from = total,
              values_fill = 0) %>%
  mutate(Total_Arrived = rowSums(across(contains("Arrived")), na.rm = TRUE),
         Total_NS_SDC = rowSums(across(contains("NS_SDC")), na.rm = TRUE)) %>%
  rowwise() %>%
  mutate(Total_NS_SDC_Rate = (Total_NS_SDC)/(Total_Arrived + Total_NS_SDC),
         CoC_NS_SDC_Rate = (CoC_NS_SDC)/(CoC_Arrived + CoC_NS_SDC),
         Non_CoC_NS_SDC_Rate = (Non_CoC_NS_SDC)/(Non_CoC_Arrived + Non_CoC_NS_SDC),
         MSS_Attributed_NS_SDC_Rate = (MSS_Attributed_NS_SDC)/(MSS_Attributed_Arrived + MSS_Attributed_NS_SDC),
         Other_Payor_NS_SDC_Rate = (Other_Payor_NS_SDC)/(Other_Payor_Arrived + Other_Payor_NS_SDC)) %>%
  mutate(MSHS = "MSHS")


```


```{r Template Utilization Updated, echo = FALSE, warning = FALSE, message = FALSE}


# Grouper 17 Mapping
# 2 = NETWORK
# 3 = OTHER 
# 4 = MSH-MSDFP
# 6 = MSUS
# 7 = MSDMG
# 8 = MSBI
# 9 = MSW
# 10 = MSHS
# 11 = MSM
# 12 = MSH- AMBULATORY CARE
# 13 = NYEE 
# 14 = MS NOW
# 15 = MSQ
# 19 = MSSN
# 38 = MSB

grp_mapping <- data.frame("SITE" = c("NETWORK", "OTHER", "MSH-MSDFP", "MSUS", 
                                        "MSDMG", "MSBI", "MSW", "MSHP", "MSM", "MSH- AMBULATORY CARE",
                                        "NYEE", "MS NOW", "MSQ", "MSSN", "MSB"),
                             "RPT_GRP_SEVNTEEN_C" = c(2, 3,4, 6, 
                                                      7, 8, 9, 10, 11, 12,
                                                      13, 14, 15, 19, 38))



slot_merged <- slot_data_prc_tbl %>%
  left_join(clarity_ser_tbl_loc %>% select(PROV_ID, PROV_TYPE)) %>%
  # filter(PROV_TYPE == "Physician") %>%
  left_join(clarity_ser_2_tbl_loc %>% 
              dplyr::select(PROV_ID, NPI, GENERIC_YN)) %>%
  filter(GENERIC_YN == "N" | is.na(GENERIC_YN)) %>%
  left_join(dep_mapping_tbl_loc %>%
              mutate(SITE = case_when(RPT_GRP_SEVNTEEN_C == 2 ~ "NETWORK", 
                                      RPT_GRP_SEVNTEEN_C == 3 ~ "OTHER", 
                                      RPT_GRP_SEVNTEEN_C == 4 ~ "MSH-MSDFP", 
                                      RPT_GRP_SEVNTEEN_C == 6 ~ "MSUS",
                                      RPT_GRP_SEVNTEEN_C == 7 ~ "MSDMG", 
                                      RPT_GRP_SEVNTEEN_C == 8 ~ "MSBI",
                                      RPT_GRP_SEVNTEEN_C == 9 ~ "MSW", 
                                      RPT_GRP_SEVNTEEN_C == 10 ~ "MSHP", 
                                      RPT_GRP_SEVNTEEN_C == 11 ~ "MSM", 
                                      RPT_GRP_SEVNTEEN_C == 12 ~ "MSH- AMBULATORY CARE",
                                      RPT_GRP_SEVNTEEN_C == 13 ~ "NYEE", 
                                      RPT_GRP_SEVNTEEN_C == 14 ~ "MS NOW", 
                                      RPT_GRP_SEVNTEEN_C == 15 ~ "MSQ", 
                                      RPT_GRP_SEVNTEEN_C == 19 ~ "MSSN", 
                                      RPT_GRP_SEVNTEEN_C == 38 ~ "MSB")) %>%
              dplyr::select(SITE, SPECIALTY, DEPARTMENT_ID) %>%
              rename("DEPT_SPECIALTY_NAME" = SPECIALTY)) 


slot_util_prov <- slot_merged %>%
  mutate(slot_date = sql("TRUNC(SLOT_BEGIN_TIME)")) %>%
  mutate(slot_year = year(SLOT_BEGIN_TIME),
         slot_month = month(SLOT_BEGIN_TIME),
         slot_week = trunc(SLOT_BEGIN_TIME, "IW")) %>%
  filter(year(slot_date) >= 2026) %>%
  filter(SLOT_BEGIN_TIME < TO_DATE(slot_date_start, "YYYY-MM-DD HH24:MI:SS")) %>%
  group_by(DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, PROV_ID, NPI, PROV_NM_WID, PROV_TYPE, slot_year, slot_month) %>%
  mutate(avail_hour = sum(REG_AVAIL_MIN, na.rm = T)/60,
            sched_hour = sum(SCHED_MIN, na.rm = T)/60,
            arrived_hour = sum(ARRIVED_MIN, na.rm = T)/60) %>%
  mutate(prov_util = case_when(avail_hour == 0 | is.na(avail_hour) ~ 0, TRUE ~ arrived_hour/avail_hour)) %>%
  filter(prov_util >=0.35 & prov_util <=2.0) %>%
  group_by(DEPT_SPECIALTY_NAME, DEPARTMENT_ID, DEPARTMENT_NAME, PROV_ID, NPI, PROV_NM_WID, PROV_TYPE, slot_year, slot_month, slot_week) %>%
  summarise(avail_hour = sum(REG_AVAIL_MIN, na.rm = T)/60,
            sched_hour = sum(SCHED_MIN, na.rm = T)/60,
            arrived_hour = sum(ARRIVED_MIN, na.rm = T)/60) %>%
  mutate(prov_util = case_when(avail_hour == 0 | is.na(avail_hour) ~ 0, TRUE ~ arrived_hour/avail_hour),
         unused_hour = ifelse(avail_hour - arrived_hour <0, 0, avail_hour - arrived_hour)) %>%
  collect() 
  
```


```{r No Show and Template Utilization}

merged <- no_show_summary %>%
  left_join(slot_util_prov %>%
              ungroup() %>%
              dplyr::select(slot_month, slot_week, DEPARTMENT_ID, PROV_ID, slot_week, avail_hour, arrived_hour, prov_util, unused_hour),
            by = c("appt_month" = "slot_month",
              "appt_week" = "slot_week",
                  "DEPARTMENT_ID" = "DEPARTMENT_ID",
                  "PROV_ID" = "PROV_ID"))


col_order <- c("MSHS","appt_year", "appt_month", "appt_week", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "DEPARTMENT_ID",
               "PROV_TYPE", "PROV_ID", "PROV_NAME_WID",
               "Total_Arrived", "CoC_Arrived", "Non_CoC_Arrived", "MSS_Attributed_Arrived", "Other_Payor_Arrived", 
               "Total_NS_SDC", "CoC_NS_SDC", "Non_CoC_NS_SDC", "MSS_Attributed_NS_SDC", "Other_Payor_NS_SDC", 
               "Total_NS_SDC_Rate", "CoC_NS_SDC_Rate", "Non_CoC_NS_SDC_Rate", "MSS_Attributed_NS_SDC_Rate", "Other_Payor_NS_SDC_Rate",
               "avail_hour", "arrived_hour", "prov_util", "unused_hour")


merged <- merged %>%
  dplyr::select(col_order)
```


## No Show and Fill Rates
```{r No Show and Fill Rate by Site, echo = FALSE, warning = FALSE, message = FALSE}


htmltools::browsable(
  tagList(
    tags$button(
      tagList(fontawesome::fa("download"), "Download Table"),
      onclick = "Reactable.downloadDataCSV('no-show-template-util', 'No Show and Fill Rates')"
    ),

# htmltools::browsable(
#   tagList(
#     div(tags$label("Summary by", `for` = "access-roi")),
#     tags$select(
#       id = "access-roi",
#       onchange = "Reactable.setGroupBy('access-metrics', this.value ? [this.value] : [])",
#       tags$option("None", value = ""),
#       lapply(c("Year", "Month"), tags$option)
#     ),
# 
#     tags$hr("aria-hidden" = "true"),
    
reactable(
  merged %>%
    arrange(as.Date(appt_week)) %>%
    mutate(appt_week = as.character(format(appt_week, "%m-%d-%Y"))) %>%
    filter(SITE %in% c("MSBI", "MSDMG", "MSH- AMBULATORY CARE", "MSH-MSDFP", "MSM", "MSQ",               
                       "MSSN",  "MSUS", "MSW", "NETWORK", "NYEE", "MSB")),
  elementId = "no-show-template-util",
  # elementId = "referral-vol-download-table",
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE,

  groupBy = c("MSHS", "appt_week", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "PROV_TYPE"),

  columnGroups = list(
    colGroup(name = "", columns = c("MSHS", "appt_week", "SITE", "DEPT_SPECIALTY_NAME", "DEPARTMENT_NAME", "DEPARTMENT_ID",
                                    "PROV_TYPE", "PROV_NAME_WID"),
             headerStyle = list(color = "black", fontSize = "15px"),
             sticky = "left"),
    colGroup(name = paste0("2026 Completed Visits (", format(as.Date("2026-01-01"), "%m/%d"),"-",format(as.Date(slot_date_start), "%m/%d"),")"),
             columns = c("Total_Arrived", "CoC_Arrived", "Non_CoC_Arrived", "MSS_Attributed_Arrived", "Other_Payor_Arrived"),
             headerStyle = list(background = "#7f7f7f", color = "white", fontSize = "15px")),
    colGroup(name = paste0("2026 No Show and Same Day Cancellations (", format(as.Date("2026-01-01"), "%m/%d"),"-",format(as.Date(slot_date_start), "%m/%d"),")"),
             columns = c("Total_NS_SDC", "CoC_NS_SDC", "Non_CoC_NS_SDC", "MSS_Attributed_NS_SDC", "Other_Payor_NS_SDC"),
             headerStyle = list(background = "#212070", color = "white", fontSize = "15px")),
    colGroup(name = paste0("No Show/Same Day Cancellation (", format(as.Date("2026-01-01"), "%m/%d"),"-",format(as.Date(slot_date_start), "%m/%d"),")"),
             columns = c("Total_NS_SDC_Rate", "CoC_NS_SDC_Rate", "Non_CoC_NS_SDC_Rate", "MSS_Attributed_NS_SDC_Rate", "Other_Payor_NS_SDC_Rate"),
             headerStyle = list(background = "#d80b8c", color = "white", fontSize = "15px")),
    colGroup(name = paste0("Template Fill Rate (", format(as.Date("01-01-2026"), "%m/%d"),"-",format(as.Date(slot_date_start), "%m/%d"),")"),
             columns = c("avail_hour", "arrived_hour", "prov_util", "unused_hour"),
             headerStyle = list(background = "#00aeef", color = "white", fontSize = "15px"))
    # colGroup(name = paste0("New Patient Capture*"),
    #          columns = c("NEW_LOS", "NEW_LOS_baseline", "new_pt_var_baseline",
    #                      "perc_new_los", "perc_new_los_baseline", "perc_new_los_var_baseline",
    #                      "perc_new_pt_target", "perc_new_los_var_target"),
    #          headerStyle = list(background = "#a5a7a5", color = "white", fontSize = "15px"))
    ),

  columns = list(

     MSHS = colDef(
      name = "MSHS",
      maxWidth = 100),
     
     # appt_month = colDef(
     #  name = "Month",
     #  maxWidth = 100),
     
     appt_week = colDef(
      name = "Week",
      minWidth = 150),
     
     SITE = colDef(
      name = "Site",
      minWidth = 200),
     
     DEPT_SPECIALTY_NAME = colDef(
      name = "Specialty",
      minWidth = 200),
     
     DEPARTMENT_NAME = colDef(
      name = "Department",
      minWidth = 200),
     # 
     # DEPARTMENT_ID = colDef(
     #  name = "Department ID",
     #  minWidth = 120),
     
     PROV_TYPE = colDef(
      name = "Type",
      minWidth = 120),
     
     PROV_NAME_WID = colDef(
      name = "Name",
      minWidth = 200),
     
     Total_Arrived = colDef(
      name = "Total",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     CoC_Arrived = colDef(
      name = "CoC",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     Non_CoC_Arrived = colDef(
      name = "Non-CoC",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     MSS_Attributed_Arrived = colDef(
      name = "MSS Attributed",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),

     Other_Payor_Arrived = colDef(
      name = "Other Payor",
      maxWidth = 80,
      headerStyle = list(background = "#7f7f7f", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     Total_NS_SDC = colDef(
      name = "Total",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     CoC_NS_SDC = colDef(
      name = "CoC",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     Non_CoC_NS_SDC = colDef(
      name = "Non-CoC",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     MSS_Attributed_NS_SDC = colDef(
      name = "MSS Attributed",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),

     Other_Payor_NS_SDC = colDef(
      name = "Other Payor",
      maxWidth = 80,
      headerStyle = list(background = "#212070", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     Total_NS_SDC_Rate = colDef(
      name = "Total",
      maxWidth = 80,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalTotal_Arrived = 0
        let totalTotal_NS_SDC = 0
        rows.forEach(function(row) {
          totalTotal_Arrived += row['Total_Arrived']
          totalTotal_NS_SDC += row['Total_NS_SDC']
        })
        return (totalTotal_NS_SDC) / (totalTotal_NS_SDC + totalTotal_Arrived) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['Total_NS_SDC_Rate']
        if (value > 0) {
          var color = '#e00000'
        } else {
          var color = '#008000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)),
     
     CoC_NS_SDC_Rate = colDef(
      name = "CoC",
      maxWidth = 80,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalCoC_Arrived = 0
        let totalCoC_NS_SDC = 0
        rows.forEach(function(row) {
          totalCoC_Arrived += row['CoC_Arrived']
          totalCoC_NS_SDC += row['CoC_NS_SDC']
        })
        return (totalCoC_NS_SDC) / (totalCoC_NS_SDC + totalCoC_Arrived) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['CoC_NS_SDC_Rate']
        if (value > 0) {
          var color = '#e00000'
        } else {
          var color = '#008000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)),
     
     Non_CoC_NS_SDC_Rate = colDef(
      name = "Non-CoC",
      maxWidth = 80,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalNon_CoC_Arrived = 0
        let totalNon_CoC_NS_SDC = 0
        rows.forEach(function(row) {
          totalNon_CoC_Arrived += row['Non_CoC_Arrived']
          totalNon_CoC_NS_SDC += row['Non_CoC_NS_SDC']
        })
        return (totalNon_CoC_NS_SDC) / (totalNon_CoC_NS_SDC + totalNon_CoC_Arrived) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['Non_CoC_NS_SDC_Rate']
        if (value > 0) {
          var color = '#e00000'
        } else {
          var color = '#008000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)),
     
     MSS_Attributed_NS_SDC_Rate = colDef(
      name = "MSS Attributed",
      maxWidth = 80,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalMSS_Attributed_Arrived = 0
        let totalMSS_Attributed_NS_SDC = 0
        rows.forEach(function(row) {
          totalMSS_Attributed_Arrived += row['MSS_Attributed_Arrived']
          totalMSS_Attributed_NS_SDC += row['MSS_Attributed_NS_SDC']
        })
        return (totalMSS_Attributed_NS_SDC) / (totalMSS_Attributed_NS_SDC + totalMSS_Attributed_Arrived) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['MSS_Attributed_NS_SDC_Rat']
        if (value > 0) {
          var color = '#e00000'
        } else {
          var color = '#008000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)),
     
     Other_Payor_NS_SDC_Rate = colDef(
      name = "Other Payor",
      maxWidth = 80,
      headerStyle = list(background = "#d80b8c", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalOther_Payor_Arrived = 0
        let totalOther_Payor_NS_SDC = 0
        rows.forEach(function(row) {
          totalOther_Payor_Arrived += row['Other_Payor_Arrived']
          totalOther_Payor_NS_SDC += row['Other_Payor_NS_SDC']
        })
        return (totalOther_Payor_NS_SDC) / (totalOther_Payor_NS_SDC + totalOther_Payor_Arrived) || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['Other_Payor_NS_SDC_Rate']
        if (value > 0) {
          var color = '#e00000'
        } else {
          var color = '#008000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)),
     
     avail_hour = colDef(
      name = "Available Hour",
      maxWidth = 80,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     arrived_hour = colDef(
      name = "Arrived Hour",
      maxWidth = 80,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     prov_util = colDef(
      name = "Fill Rate",
      maxWidth = 80,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      aggregate = JS("function(values, rows) {
        let totalavail_hour = 0
        let totalarrived_hour = 0
        rows.forEach(function(row) {
          totalavail_hour += row['avail_hour']
          totalarrived_hour += row['arrived_hour']
        })
        return (totalarrived_hour) / totalavail_hour || '-'
      }"),
      style = JS("function(rowInfo) {
        var value = rowInfo.row['prov_util']
        if (value > 0.85) {
          var color = '#008000'
        } else {
          var color = ' #e00000'
        }
        return { color: color, fontFamily: 'calibri', fontWeight: 'bold'}
      }"),
      format = colFormat(percent = TRUE, digits = 1)),
     
     unused_hour = colDef(
      name = "Unused Hour",
      maxWidth = 80,
      headerStyle = list(background = "#00aeef", color = "white", fontWeight = "Bold", fontSize = "14px"),
      style = list(color = "red", fontWeight = "Bold"),
      aggregate = 'sum',
      format = colFormat(separators = TRUE, digits = 0)),
     
     appt_year = colDef(show =F),
     appt_month = colDef(show =F),
     DEPARTMENT_ID = colDef(show =F),
     PROV_ID = colDef(show =F)
     
  ) # Close Columns

  ) # Close Reactable
) # Close Taglist
) # Close htmltools

```



<!-- ```{r} -->

<!-- lead_days <- access_raw_tbl %>% -->
<!--   left_join(finclass_tbl %>%  -->
<!--               filter(PRD_TYPE == "EXCHANGE") %>% -->
<!--               dplyr::select(PLAN_NAME, PRD_TYPE) %>% -->
<!--               distinct(),  -->
<!--             by = c("VISITPLAN" = "PLAN_NAME")) %>% -->
<!--   left_join(tbl(conn2, "PATIENT_FYI_FLAGS") %>% -->
<!--               dplyr::select(PATIENT_ID, PAT_FLAG_TYPE_C) %>% -->
<!--               filter(PAT_FLAG_TYPE_C %in% c(2108, 2109, 2110)), -->
<!--             by = c("PAT_ID" = "PATIENT_ID")) %>% -->
<!--   mutate(FINCLASS = case_when(PRD_TYPE == "EXCHANGE" ~ "EXCHANGE", TRUE ~ FINCLASS)) %>% -->
<!--   mutate(MSS_GROUP = case_when(GROUP_NUM %in% mss_exclusion_list ~ "MSS", TRUE ~ "")) %>% -->
<!--   mutate(ANTHEM = case_when(VISITPLAN %in% anthem_plan_list ~ "Anthem", TRUE ~ "")) %>% -->
<!--   filter(year(CONTACT_DATE)>=2026) %>% -->
<!--   filter(CONTACT_DATE < TO_DATE(date_start, "YYYY-MM-DD HH24:MI:SS")) %>% -->
<!--   mutate(lead_days = CONTACT_DATE - APPT_MADE_DATE) %>% -->
<!--   mutate(cancel_lead_days = APPT_DTTM - APPT_CANC_DTTM) %>% -->
<!--    filter(DERIVED_STATUS_DESC == "Arrived" |  -->
<!--            DERIVED_STATUS_DESC == "No Show" | -->
<!--            (DERIVED_STATUS_DESC == "Canceled" & cancel_lead_days <= 1) | -->
<!--            (DERIVED_STATUS_DESC == "Rescheduled" & cancel_lead_days <= 1)) %>% -->
<!--   mutate(appt_year = year(CONTACT_DATE), -->
<!--          appt_month = month(CONTACT_DATE), -->
<!--          appt_week = trunc(CONTACT_DATE, "IW")) %>%  -->
<!--   mutate(appt_made_year = year(APPT_MADE_DATE), -->
<!--          appt_made_month = month(APPT_MADE_DATE)) %>% -->
<!--   mutate(visit_type = ifelse(is.na(VISIT_GROUP_NUM), "ESTABLISHED", "NEW")) %>% -->
<!--   mutate(lead_14days = ifelse(lead_days <= 14, "lead_14days", "lead_14days_more")) %>% -->
<!--   group_by(SITE, DEPT_SPECIALTY_NAME, DEPARTMENT_NAME, DEPARTMENT_ID, DERIVED_STATUS_DESC, -->
<!--            CONTACT_DATE, appt_year, appt_month, appt_week, PAT_FLAG_TYPE_C, MSS_GROUP, ANTHEM) %>% -->
<!--   summarise(total = n()) %>% -->
<!--   collect()  -->

<!-- ``` -->

## Note
### Count of Weekdays for 2025 vs. 2026 Volume Comparison
```{r Notes}

    
reactable(
  appt_day_comparison,
  style = list(fontFamily = 'Calibri',
                 fontSize = '14px'),
    defaultColDef = colDef(align = "left",
                           headerStyle = list(fontWeight = "Bold", fontSize = "14px"),
                           headerClass = "bar-sort-header"),
  # RowStyle = function(index) {
  #           if (index %in% c(nrow(referral_vol_site_data_mshs))) {
  #             list(`border-top` = "2px solid rgb(184,184,184)",
  #                  fontWeight = "Bold")
  #           }
  #         },
    highlight = TRUE,
    # filterable = TRUE,
    pagination = FALSE,
    # height = 800,
    wrap = TRUE,
  searchable = TRUE

  ) # Close Reactable


```

